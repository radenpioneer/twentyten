---
import DoubleColumnLayout, {
  type Props as DoubleColumnLayoutProps
} from '~/layouts/double.astro'
import Article from '~/components/article/article.astro'
import Result from '~/components/search/result.astro'
import NoResult from '~/components/search/no-result.astro'
import { getCollection } from 'astro:content'
import Fuse from 'fuse.js'

const posts = await getCollection('posts')
const fuse = new Fuse(posts, {
  keys: [
    'body',
    'data.title',
    'data.subtitle',
    'data.description',
    'data.tags.name'
  ],
  ignoreLocation: true
})

const query = Astro.url.searchParams.get('q')
const result = fuse.search(query || '')

const page = {
  title: 'Search',
  description: `Search results page of query: ${query}`
} satisfies DoubleColumnLayoutProps

export const prerender = false
---

<DoubleColumnLayout {...page}>
  <Article title={page.title} class='mx-auto prose-h1:mb-4'>
    {(query && result.length > 0) && <Result query={query} result={result} />}
    {(result.length <= 0) && <NoResult query={query || ''} />}
  </Article>
</DoubleColumnLayout>
